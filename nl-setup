#!/usr/bin/env bash

## Variables
APKREPOS_PATH="${ROOT}"etc/apk/repositories


add_fastest_mirror() {
	echo "Finding fastest mirror... "
	local fastest="$(find_fastest_mirror)"
	if [ -z "$fastest" ]; then
		echo "Warning! No mirror found" >&2
		return 1
	fi
	add_mirror "$fastest"
}

# For every main/ repo, enable corresponding community/ repo
add_community_mirrors() {
	for repo in $(grep '^[^#].*/main$' "$APKREPOS_PATH" 2>/dev/null); do
		crepo="${repo%%/main}/community"
		if ! grep -qx -- "$crepo" "$APKREPOS_PATH"; then
			echo ">>> Enabling repository $crepo"
			echo "$crepo" >> "$APKREPOS_PATH"
		fi
	done
}

add_fastest_mirror
add_community_mirrors
